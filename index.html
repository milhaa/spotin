<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpotN</title>

    <!-- ======== FONTS ======================== -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Relief:wght@400;700&family=Zain:ital,wght@0,200;0,300;0,400;0,700;0,800;0,900;1,300;1,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- ======== LINK CSS ======================== -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- ======== FAVICON ======================== -->
    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
    <link rel="manifest" href="img/favicon/site.webmanifest">
    <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#2d89ef">
    <meta name="theme-color" content="#ffffff">
</head>

<body>
    <div class="wrapper">
    
        <header class="header">
            <div class="container">
                <div class="header__inner">
                    <a href="/" class="header__logo">
                        <img src="img/spotn-logo-en.png" alt="img" class="header__logo--img img">
                    </a>
                    
                    <nav class="menu">
                        <ul class="menu__list">
                            <li class="menu__item">
                                <a href="#restaurant" class="menu__link">المطاعم و الكافيهات</a>
                            </li>
                             
                            <li class="menu__item">
                                <a href="#map" class="menu__link">الخريطة</a>
                            </li>
                        </ul>
                    </nav>
                     
                    <div class="header__button">
                        <a id="sign-up-btn" href="#popup-sign" class="header__btn popup-link">تسجيل الدخول</a>
                    </div>

                    <div class="header__burger">
                        <span></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- ---------------Main section-------------- -->
        <main class="main">
            <section class="hero">
                <div class="container">
                    <div class="hero__inner">
                        <div class="hero__body">
                            <h1>وجهتك الأولى لاكتشاف المطاعم و الكافيهات</h1>
                            <a href="#filters" class="hero__btn btn">اكتشف معنا</a>
                        </div>
                        <!-- Updated slideshow section -->
                        <div class="hero__slideshow">
                            <div class="slideshow-container">
                                <!-- Slide 1 -->
                                <div class="slide active">
                                    <img src="img/hero/11.jpg" 
                                         alt="Coffee Shop Interior" class="slide__img">
                                </div>

                                <!-- Slide 2 -->
                                <div class="slide">
                                    <img src="img/hero/7.png" 
                                         alt="Restaurant Dining" class="slide__img">
                                </div>
                                
                                <!-- Slide 3 -->
                                <div class="slide">
                                    <img src="img/hero/8.png" 
                                         alt="Delicious Food" class="slide__img">
                                </div>
                                
                                <!-- Slide 4 -->
                                <div class="slide">
                                    <img src="img/hero/9.png" 
                                         alt="Coffee and Pastries" class="slide__img">
                                </div>
                                
                                <!-- Slide 5 -->
                                <div class="slide">
                                    <img src="img/hero/10.jpg" 
                                         alt="Restaurant Atmosphere" class="slide__img">
                                </div>
                                
                                <!-- Slide indicators -->
                                <div class="slide-indicators">
                                    <span class="indicator active" data-slide="0"></span>
                                    <span class="indicator" data-slide="1"></span>
                                    <span class="indicator" data-slide="2"></span>
                                    <span class="indicator" data-slide="3"></span>
                                    <span class="indicator" data-slide="4"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- =============== Enhanced Restaurant Section with Filters ============== -->
            <section class="our-menu" id="restaurant">
                <div class="container">
                    <!-- Search Section -->
                    <div class="search-section" id="filters">
                        <div class="search-container">
                            <input type="search" class="search-input" id="nameFilter" placeholder="ادخل اسم المطعم او الكافيه ...">
                            <button type="submit" class="search-button">
                                <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="#032d70" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Filters Section -->
                    <div class="filters-section">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label>الوجهة</label>
                                <select id="destinationFilter">
                                    <option value="">الكل</option>
                                    <option value="مطعم">مطعم</option>
                                    <option value="كافيه">كوفي</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label>النوع / التصنيف</label>
                                <select id="cuisineFilter">
                                    <option value="">-- اختر النوع --</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label>عدد الأشخاص</label>
                                <select id="peopleFilter">
                                    <option value="">غير محدد</option>
                                    <option value="1">1</option>
                                    <option value="2-5">2-5</option>
                                    <option value="5+">5 فأكثر</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label>الأجواء</label>
                                <select id="atmosphereFilter">
                                    <option value="">جميع الأجواء</option>
                                    <option value="عائلية">عائلية</option>
                                    <option value="رومانسية">رومانسية</option>
                                    <option value="اطلالة">اطلالة</option>
                                    <option value="فاخرة">فاخرة</option>
                                    <option value="هادئة">هادئة</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-buttons">
                            <button class="btn-filter btn-secondary">حذف</button>
                        </div>
                    </div>

                    <!-- =========Restaurants section ==================-->
                    <div class="container" id="restaurant">
                        <h2>المطاعم و الكافيهات</h2>
                    </div>

                    <!-- Restaurant Cards Container -->
                    <div class="our-menu__inner">
                        <div class="our-menu__raw" id="restaurantsContainer">
                            <!-- Restaurant cards will be generated here by JavaScript -->
                            <div class="loading-message" style="text-align: center; color: #032d70; font-size: 18px; padding: 40px;">
                                جاري تحميل المطاعم والكافيهات ...
                            </div>
                        </div>
                    </div>

                    <!-- Pagination Container -->
                    <div class="pagination-container" id="paginationContainer">
                        <!-- Pagination will be generated here by JavaScript -->
                    </div>

                    <!-- No Results Message -->
                    <div class="no-results" id="noResults" style="display: none;">
                        <h3>لا توجد نتائج</h3>
                        <p>لم نجد مطاعم تطابق معايير البحث الخاصة بك</p>
                    </div>
                </div>
            </section>

            <!---------------- FIXED Map Section ------------------->
            <section class="map" id="map">
                <div class="container">
                    <h2>الخريطة</h2>
                    <div class="map__inner">
                        <!-- Status Messages -->
                        <div id="mapStatus" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 8px; text-align: center; font-size: 14px;"></div>
                        
                        <div class="map__maps">
                            <!-- Map container with explicit styling -->
                            <div id="mapContainer" style="width: 100%; height: 460px; border-radius: 22px; background: #f0f0f0; display: block; position: relative;"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="advantages">
                <div class="container">
                </div>
            </section> 
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer__inner">
                    <div class="footer__block">
                        <a href="/" class="footer__logo">
                            <img src="img/spotn-logo-en.png" alt="img" class="footer__logo--img img">
                        </a>
                        
                        <!-- Add social media section if you want it -->
                        <div class="footer-social">
                            <div class="footer-social__list">
                                <!-- Add your social media links here if needed -->
                            </div>
                        </div>
                    </div>

                    <!-- Navigation section with proper class names -->
                    <div class="footer__block">
                        <nav class="footer-nav">
                            <h3 class="footer-nav__title">روابط سريعة</h3>
                            <ul class="footer-nav__list">
                                <li class="footer-nav__item">
                                    <a href="#restaurant" class="footer-nav__link">المطاعم و الكافيهات</a>
                                </li>
                               
                                <li class="footer-nav__item">
                                    <a href="index.html#map" class="footer-nav__link">الخريطة</a>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <!-- Contact section with proper class names -->
                    <div class="footer__block">
                        <nav class="footer-location">
                            <h3 class="footer-location__title">تواصل معنا</h3>
                            <ul class="footer-nav__list">
                                <li class="footer-nav__item">
                                    <a href="https://www.google.com/maps/place/%D9%85%D9%84%D8%AD%D8%A9+%D9%84%D9%84%D8%A3%D8%B9%D9%85%D8%A7%D9%84+%D9%88%D8%A7%D8%A8%D8%AA%D9%83%D8%A7%D8%B1%E2%80%AD/@18.2396379,42.5809106,935m/data=!3m2!1e3!4b1!4m6!3m5!1s0x15fcab001cc380cd:0xa52efef5cd2e98da!8m2!3d18.2396379!4d42.5809106!16s%2Fg%2F11x8rkjfzg?entry=ttu&g_ep=EgoyMDI1MDYyMi4wIKXMDSoASAFQAw%3D%3D" class="footer-nav__link" target="_blank">
                                        <img src="img/icon/location.svg" alt="img" class="footer-location__img img" style="filter: brightness(0) saturate(100%) invert(12%) sepia(95%) saturate(3441%) hue-rotate(215deg) brightness(96%) contrast(108%); margin-left: 10px;">
                                        ابها طريق الملك فهد
                                    </a>
                                </li>
                                
                                <li class="footer-nav__item">
                                    <a href="mailto:spotin.services@gmail.com" class="footer-nav__link">
                                        <img src="img/icon/message.svg" alt="img" class="footer-location__img img" style="filter: brightness(0) saturate(100%) invert(12%) sepia(95%) saturate(3441%) hue-rotate(215deg) brightness(96%) contrast(108%); margin-left: 10px;">
                                        spotin.services@gmail.com           
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ==================Enhanced OTP Popup System=========================== -->
    <!-- نافذة تسجيل الدخول الأولى -->
    <div id="popup-sign" class="popup">
        <div class="popup__body">
            <div class="popup__content">
                <a href="#" class="popup__close close-popup">&#10006;</a>
                <div class="popup__form">
                    <div class="popup__logo-otp" style="background-color: white;">
                        <img src="img/spotn-logo-en.png" alt="Logo" style="width: 50px; height: 50px; object-fit: contain;">
                    </div>
                    
                    <div class="step-indicator">
                        <div class="step active">1</div>
                        <div class="step-line"></div>
                        <div class="step">2</div>
                    </div>
                    
                    <h2>يا هلا فيك في !<br>
                        سجل معنا في عضوية Spot in
                    </h2>
                    
                    <form action="#otp-verification" method="post">
                        <div class="contact__icon--loading">
                            <img src="img/icon/loading.gif" alt="Loading">
                        </div>
                        
                        <input type="hidden" name="formData" value=" ">
                        
                        <div class="popup__input-tel popup__input">
                            <input class="popup-input" type="text" name="name" placeholder="ادخل اسمك" required>
                        </div>
                        
                        <div class="popup__input-tel popup__input">
                            <input class="popup-input" type="tel" name="phone" placeholder="ادخل رقم جوالك" required>
                        </div>
                        
                        <button type="button" id="register-btn" class="popup__btn">تحقق</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<!-- نافذة التحقق من OTP -->
<div id="otp-verification" class="popup">
    <div class="popup__body">
        <div class="popup__content">
            <a href="#" class="popup__close close-popup">&#10006;</a>
            <div class="popup__form">
                <div class="popup__logo-otp" style="background-color: white;">
                    <img src="img/spotn-logo-en.png" alt="Logo" style="width: 50px; height: 50px; object-fit: contain;">
                </div>

                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step-line completed"></div>
                    <div class="step active">2</div>

                </div>

                <h2> تحقق من رقم جوالك </h2>
                <p>
                    تم إرسال رمز التحقق إلى رقم جوالك<br>
                    يرجى إدخال الرمز المكون من 4 أرقام
                </p>

                <form action="#modal-thank" method="post">
                    <div class="otp-container">
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                    </div>

                    <p class="resend-text">
                        لم تتلق الرمز؟ <a href="#" class="resend-link">إعادة الإرسال</a>
                    </p>

                    <a href="#modal-thank" class="popup__btn">تأكيد</a>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- نافذة الشكر والنجاح -->
<div id="modal-thank" class="popup">
    <div class="popup__body">
        <div class="popup__content popup__content-thank">
            <a href="#" class="popup__close close-popup">&#10006;</a>
            <div class="popup__form popup__form-thank">
                <div class="popup__logo-otp">✓</div>

                <div class="step-indicator">
                    <div class="step completed">1</div>
                    <div class="step-line completed"></div>
                    <div class="step completed">2</div>

                </div>

                <h2>شكرًا لك</h2>
                <p>
                    تم تسجيلك بنجاح<br>
                 </p>

                <a href="#" class="popup__btn close-popup" style="margin-top: 30px;">ابدأ الآن</a>
            </div>
        </div>
    </div>
</div>



    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/3.3.4/jquery.inputmask.bundle.min.js"></script>
    <script src="js/popup.js"></script>
    <script src="js/script.js"></script>
    <script src="js/restaurants.js"></script>

    <!-- CRITICAL Map CSS Overrides -->
    <style>
        /* Map-specific overrides - HIGH PRIORITY */
        #mapContainer {
            width: 100% !important;
            height: 460px !important;
            min-height: 460px !important;
            display: block !important;
            position: relative !important;
            z-index: 1 !important;
        }

        .map__maps {
            overflow: visible !important;
            height: auto !important;
        }

        /* Status messages */
        .status-success {
            background-color: #e8f5e8 !important;
            color: #2e7d32 !important;
            border: 1px solid #4caf50 !important;
        }

        .status-error {
            background-color: #ffebee !important;
            color: #c62828 !important;
            border: 1px solid #f44336 !important;
        }

        /* Responsive map */
        @media (max-width: 768px) {
            #mapContainer {
                height: calc(340px + (460 - 340) * ((100vw - 320px) / (768 - 320))) !important;
            }
        }

        @media (max-width: 550px) {
            #mapContainer {
                border-radius: 10px !important;
            }
        }

        /* Loading spinner */
        #searchSpinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- WORKING Map JavaScript-->
    <script>
        // Simple, conflict-resistant map initialization
        let mapInstance = null;
        let mapMarker = null;
        let infoWindow = null;

        // Initialize Google Maps
        function initMap() {
            console.log('Starting map initialization...');
            
            const mapContainer = document.getElementById('mapContainer');
            if (!mapContainer) {
                console.error('Map container not found!');
                return;
            }
            
            console.log('Container dimensions:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);
            
            try {
                const defaultLocation = { lat: 18.2416677, lng: 42.4660164 };
                
                // Create map with MINIMAL configuration
               mapInstance = new google.maps.Map(mapContainer, {
            center: defaultLocation,
            zoom: 12,
            styles: [
                {
                    featureType: "poi",
                    stylers: [{ visibility: "off" }]
                },
                {
                    featureType: "transit",
                    stylers: [{ visibility: "off" }]
                },
                {
                    featureType: "road",
                    elementType: "labels.icon",
                    stylers: [{ visibility: "off" }]
                }

            ]


        });
                
                // Create info window
                infoWindow = new google.maps.InfoWindow();
                
                console.log('Map initialized successfully!');
                showMapStatus('تم تحميل الخريطة بنجاح', 'success');
                
                // Setup search AFTER map is ready
                setTimeout(setupMapSearch, 1000);
                
            } catch (error) {
                console.error('Map initialization failed:', error);
                showMapStatus('فشل في تحميل الخريطة', 'error');
            }

            loadAllPlaces();
        }

        // Setup search functionality
        function setupMapSearch() {
            const searchButton = document.getElementById('mapSearchButton');
            const searchInput = document.getElementById('mapSearchInput');
            
            if (!searchButton || !searchInput || !mapInstance) {
                console.log('Search setup incomplete - retrying in 2 seconds...');
                setTimeout(setupMapSearch, 2000);
                return;
            }
            
            // Search button click
            searchButton.addEventListener('click', performMapSearch);
            
            // Enter key press
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performMapSearch();
                }
            });
            
            // Clear status when typing
            searchInput.addEventListener('input', function() {
                hideMapStatus();
            });
            
            console.log('Search functionality ready');
        }

        // Perform map search
       function performMapSearch() {
    const searchInput = document.getElementById('mapSearchInput');
    const name = searchInput.value.trim();
    
    if (!name) {
        showMapStatus('يرجى إدخال اسم المطعم أو الكافيه', 'error');
        searchInput.focus();
        return;
    }
    
    console.log('Searching for place by name:', name);
    
    // Show loading state
    setMapLoadingState(true);
    hideMapStatus();
    
    fetch(`http://localhost:8080/api/v1/place/search?name=${encodeURIComponent(name)}`)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            return res.json();
        })
       .then(data => {
    console.log('Search result:', data);

    if (data && data.length > 0) {
        const place = data[0];
        console.log("Place coordinates:", place.latitude, place.longitude);

        if (place.latitude && place.longitude) {
            const latLng = { lat: place.latitude, lng: place.longitude };

            mapInstance.setCenter(latLng);
            mapInstance.setZoom(15);

            // Remove previous marker
            if (mapMarker) {
                mapMarker.setMap(null);
            }

            // Create new marker
            mapMarker = new google.maps.Marker({
                position: latLng,
                map: mapInstance,
                title: place.name
            });

            // Show info window
            const content = `
            <div style="padding: 8px; max-width: 250px;">
            <h4 style="margin: 0 0 8px 0; color: #032d70;">${place.name}</h4>
            <p style="margin: 4px 0; color: #666; font-size: 12px;">
                ${place.address || ''}
            </p>
            <p style="margin: 6px 0;">
            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.googlePlaceId || ''}"
               target="_blank"
               style="color: #1a73e8; text-decoration: underline; font-size: 13px;">
                عرض في خرائط Google
            </a>
        </p>
    </div>
`;

            infoWindow.setContent(content);
            infoWindow.open(mapInstance, mapMarker);

            showMapStatus(`تم العثور على: ${place.name}`, 'success');

        } else {
            showMapStatus('موقع هذا المطعم أو الكافيه غير متوفر', 'error');
        }

    } else {
        showMapStatus('لم يتم العثور على المطعم أو الكافيه المطلوب', 'error');
    }
})
        .catch(error => {
            console.error('Search failed:', error);
            showMapStatus('حدث خطأ أثناء البحث: ' + error.message, 'error');
        })
        .finally(() => {
            setMapLoadingState(false);
        });
}


        // Show/hide loading state
        function setMapLoadingState(isLoading) {
            const searchIcon = document.getElementById('searchIcon');
            const searchSpinner = document.getElementById('searchSpinner');
            const searchButton = document.getElementById('mapSearchButton');
            
            if (isLoading) {
                searchButton.disabled = true;
                searchIcon.style.display = 'none';
                searchSpinner.style.display = 'inline-block';
            } else {
                searchButton.disabled = false;
                searchIcon.style.display = 'inline-block';
                searchSpinner.style.display = 'none';
            }
        }

        // Show map status messages
        function showMapStatus(message, type) {
            const statusElement = document.getElementById('mapStatus');
            if (!statusElement) return;
            
            statusElement.textContent = message;
            statusElement.className = type === 'success' ? 'status-success' : 'status-error';
            statusElement.style.display = 'block';
            
            // Auto hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }

function loadAllPlaces() {
    fetch("http://localhost:8080/api/v1/place")
        .then(res => res.json())
        .then(data => {
            console.log("Places loaded:", data);

            // Create ONE shared InfoWindow instance
            const sharedInfoWindow = new google.maps.InfoWindow();

            data.forEach(place => {
                const latLng = { lat: place.latitude, lng: place.longitude };
                const marker = new google.maps.Marker({
                    position: latLng,
                    map: mapInstance,
                    title: place.name
                });

                marker.addListener("click", () => {
                    const infoWindowContent = `
                        <div style="padding: 8px; max-width: 250px;">
                            <h4 style="margin: 0 0 8px 0; color: #032d70;">${place.name}</h4>
                            <p style="margin: 4px 0; color: #666; font-size: 12px;">
                                ${place.address || ''}
                            </p>
                            <p style="margin: 6px 0;">
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name)}&query_place_id=${place.googlePlaceId || ''}"
                                   target="_blank"
                                   style="color: #1a73e8; text-decoration: underline; font-size: 13px;">
                                    عرض في خرائط Google
                                </a>
                            </p>
                        </div>
                    `;


                    sharedInfoWindow.setContent(infoWindowContent);
                    sharedInfoWindow.open(mapInstance, marker);
                });
            });
        })
        .catch(error => {
            console.error("Failed to load places:", error);
        });
}

        // Error handling
        window.addEventListener('error', function(event) {
            if (event.filename && event.filename.includes('maps.googleapis.com')) {
                console.error('Google Maps script error:', event.message);
                showMapStatus('خطأ في تحميل مكتبة خرائط Google', 'error');
            }
        });

        // Authentication failure handler
        window.gm_authFailure = function() {
            console.error('Google Maps authentication failed!');
            showMapStatus('فشل في المصادقة مع Google Maps - تحقق من مفتاح API', 'error');
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready - waiting for Google Maps...');
        });

    </script>



    <!-- Load Google Maps API-->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXg8TBvFY5Xv-V93qkPsYQ5cwdIKfi5T4&callback=initMap">
    </script>

</body>
</html>
